var Room=new function(){function F(a){function x(a){q.setOn(!0);r.setVisible(!0)}function y(){q.setOn(!1);r.setVisible(!1)}function z(a){a=Message.error({message:a.message});t(a)}EventEnabledBuilder(this);var A=this,B=!1,d=a.buttonSend,u=a.buttonExit,n=a.buttonEmoticons,v=a.buttonClose,q=a.buttonVideoPmStart,t=a.addMessage,g=a.videoFeed,C=a.videoPmOfferRejected;a=a.spinner;var h=E.DIV();h.classList.add("room");var m=E.DIV();m.classList.add("top");var p=E.DIV();p.classList.add("bottom");var e=E.DIV();
e.classList.add("feed");var f=E.DIV();f.classList.add("menu");var b=E.TEXT();b.classList.add("text");if(g){g=new VideoFeedUI(g);var l=new SplitPane({nPanelsWidth:1,nPanelsHeight:2,rowProfiles:[{height:"200px"}]});var k=l.getPanelXY(0,0).getElement();var r=l.getPanelRow(0);k.classList.add("video-feed-panel");k.appendChild(g.getElement());m.appendChild(l.getElement());l.getPanelXY(0,1).getElement().appendChild(e);y();(new Task(l.resize)).run();g.addEventListener("show",x);g.addEventListener("hide",
y);g.addEventListener("showmessagetouser",z);g.addEventListener("offerrejected",C)}else m.appendChild(e);h.appendChild(m);h.appendChild(p);h.appendChild(a.getElement());p.appendChild(b);p.appendChild(f);f.appendChild(n.getElement());f.appendChild(d.getElement());f.appendChild(u.getElement());f.appendChild(v.getElement());q&&f.appendChild(q.getElement());b.addEventListener("keypress",function(a){a||(a=window.events);A.dispatchEvent({type:"keypress",keyCode:a.keyCode||a.which})});this.getElement=function(){return h};
this.getFeed=function(){return e};this.setVisible=function(a){B=a;h.style.display=a?"block":"none"};this.getVisible=function(){return B};this.getTextValue=function(){return b.value};this.addMessage=function(a){e.appendChild(a.getElement())};this.removeMessage=function(a){e.removeChild(a.getElement())};this.insertIntoTextAtCurrentIndex=function(a){var c=b.selectionStart;if(a){if(void 0==c)b.value+=a;else{var d=c+a.length;b.value=b.value.splice(c,0,a);b.selectionStart=b.selectionEnd=d}b.focus()}};this.clearText=
function(){b.value=""};this.scrollFeedToBottom=function(){e.scrollTop=e.scrollHeight};this.feedIsAtBottom=function(){return e.scrollTop>=e.scrollHeight-e.offsetHeight-10};this.resize=function(){console.log("Room.UI.resize");l&&l.resize()}}return function(a){function x(a){a.emoticonsParser=C;a.clickMenuUser=l;a.ignoreManager=b;a.getUserMe=n;w.addReceived(Message.fromJSON(a))}function y(){f.start()}function z(){w.dispose();d.dispatchEvent({type:"dispose",room:d})}function A(){var a=c.getTextValue();
if(""!=a){var b=n();a=Message.fromTypedString({str:a,userId:b.getId(),username:b.getUsername(),uniqueId:w.nextUniqueId(),emoticonsParser:C,pending:!0,clickMenuUser:l,getUserMe:n,image:b.getImage()});console.log(a);d.dispatchEvent(d.isPm()?{type:"sendpm",userToId:d.getUserTo().getId(),message:a}:{type:"sendmessage",message:a,roomId:m});w.addSending(a);c.clearText();c.scrollFeedToBottom()}}function B(a){c.insertIntoTextAtCurrentIndex(a.getStringRepresentation())}console.log(a);EventEnabledBuilder(this);
var d=this,u=a.send,n=a.getUserMe,v=a.getUserById,q=a.getNDevice,t=a.getSessionId,g=a.showUsersSearch,C=a.emoticonsParser,h=a.name,m=a.id,p=a.isPm,e=a.userTo;if(p){var f=new VideoFeedPm({userTo:e,getSessionId:t,send:u});this.videoOffer=f.incomingOffer;this.videoAccept=f.incomingAccept;this.videoIceCandidate=f.incomingIceCandidate}var b=a.ignoreManager,l=a.clickMenuUser,k=new Users({getUserById:v}),r=new UsersMenu({name:a.isPm?"PM with "+a.userTo.getUsername():h+" Users",users:k,id:m,ignoreManager:b,
clickMenu:l,getUserMe:n,showUsersSearch:g});u=new Button({className:"button-send",text:"Send"});v=new Button({className:"button-emoticons"});t=new Button({className:"button-exit"});g=new Button({className:"button-close"});h=p?new VideoButton({className:"button-video-pm-start"}):void 0;var D=new Spinner({});D.show();var c=new F({buttonSend:u,buttonEmoticons:v,buttonExit:t,buttonClose:g,buttonVideoPmStart:h,spinner:D,videoFeed:f,addMessage:function(a){var G=c.feedIsAtBottom();w.add(a);G&&c.scrollFeedToBottom()},
videoPmOfferRejected:function(a){console.log(a);d.dispatchEvent({type:"videopmofferrejected",userToId:e.getId(),reason:a.reason})}}),w=new Messages({getUserId:function(){var a=n();if(a)return a.getId()},element:c.getFeed(),maxNMessages:100,ignoreManager:b,getNDevice:q});k.addEventListener("missingusers",d.dispatchEvent);this.getId=function(){return a.id};this.getName=function(){return a.name};this.getUsersMenu=function(){return r};this.getUserTo=function(){return a.userTo};this.isPm=function(){return p};
this.incomingMessage=function(a){var b=c.feedIsAtBottom();x(a);b&&c.scrollFeedToBottom()};this.incomingMessages=function(a){var b=c.feedIsAtBottom();each(a,function(a){x(a)});b&&c.scrollFeedToBottom();D.hide()};w.addEventListener("showpm",function(a){d.dispatchEvent(a)});this.join=function(a){k.contains(a)||k.add(a)};this.leave=function(a){k.contains(a)&&k.remove(a)};this.close=z;this.getUsers=function(){return k};this.getElement=c.getElement;this.setVisible=function(a){var b=c.getVisible();!b&&a?
r.show():b&&!a&&r.hide();c.setVisible(a);a&&(new Task(function(){c.resize();c.scrollFeedToBottom()})).run()};this.getVisible=c.getVisible;this.videoOfferFail=function(a){f.stop();Dialog.show({message:"Starting video chat with "+e.getUsername()+" failed as they are offline!",buttons:[{text:"OK"}]})};this.videoOfferRejected=function(a){f.stop();Dialog.show({message:a.reason,buttons:[{text:"OK"}]})};this.resize=c.resize;u.addEventListener("click",A);v.addEventListener("click",function(){d.dispatchEvent({type:"showemoticons",
picked:B})});g.addEventListener("click",z);t.addEventListener("click",function(){d.dispatchEvent({type:"hide",room:d})});h&&h.addEventListener("click",y);c.addEventListener("keypress",function(a){if("13"==a.keyCode)return A(),!1});(new Task(function(){d.dispatchEvent(d.isPm()?{type:"getpms",userToId:d.getUserTo().getId()}:{type:"getmessages",roomId:m});d.dispatchEvent({type:"getuserids",roomId:m});d.isPm()&&(k.add(a.userTo),k.add(n()))})).run()}};